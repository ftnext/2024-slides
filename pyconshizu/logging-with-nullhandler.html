<!DOCTYPE html>

<html lang="ja" data-content_root="../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <title>ライブラリ開発者に贈る「ロギングで NullHandler 以外はいけません」</title>
    <link rel="stylesheet" type="text/css" href="../_static/revealjs4/dist/reveal.css?v=ba26b9ed" />
    <link rel="stylesheet" href="../_static/revealjs4/dist/theme/black.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/revealjs4/plugin/highlight/zenburn.css?v=83d5745d" />
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css" />
    <link rel="stylesheet" type="text/css" href="../_static/css/common.css?v=c1f4a920" />
    <link rel="stylesheet" type="text/css" href="../_static/design-style.1e8bd061cd6da7fc9cf755528e8ffc24.min.css?v=0a3b3ea7" />
    <script src="../_static/design-tabs.js?v=36754332"></script>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">


    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:site" content="@ftnext">
    <meta property="og:type" content="article">
    <meta property="og:url" content="https://ftnext.github.io/2024-slides/pyconshizu/logging-with-nullhandler.html">
    <meta property="og:title" content="ライブラリ開発者に贈る「ロギングで NullHandler 以外はいけません」">
    <meta property="og:description" content="PyCon mini Shizuoka 2024">
    <meta property="og:image" content="https://ftnext.github.io/2024-slides/_static/ogps/pyconshizu.png">

  </head><body>
    <div class="reveal">
        <div class="slides" role="main">
            <section>
<h1 style="word-break: keep-all; overflow-wrap: break-word;">ライブラリ開発者に贈る「ロギングで <code class="docutils literal notranslate"><span class="pre">NullHandler</span></code> 以外はいけません」</h1>
</section>
<section>
<ul class="simple">
<li><p>2024/08/31に <a class="reference external" href="https://shizuoka.pycon.jp/2024" rel="noopener noreferrer" target="_blank">PyCon mini Shizuoka 2024</a> が開催予定でしたが、<a class="reference external" href="https://x.com/PyconShizu/status/1828772017220550694" rel="noopener noreferrer" target="_blank">台風10号のために延期</a> となりました</p></li>
<li><p>発表準備をしていたので、手元で収録して公開しています（振替開催版は別に用意します）</p></li>
</ul>
</section>
<section>
<h2 style="word-break: keep-all; overflow-wrap: break-word;">ライブラリ開発者に贈る「ロギングで <code class="docutils literal notranslate"><span class="pre">NullHandler</span></code> 以外はいけません」</h2>
<dl class="field-list simple">
<dt class="field-odd">Event<span class="colon">:</span></dt>
<dd class="field-odd"><p>PyCon mini Shizuoka 2024（<strong>延期</strong>）</p>
</dd>
<dt class="field-even">Presented<span class="colon">:</span></dt>
<dd class="field-even"><p>2024/08/31 nikkie</p>
</dd>
</dl>
</section>
<section>
<section>
<h2 style="word-break: keep-all; overflow-wrap: break-word;">お前、誰よ</h2>
<ul class="simple">
<li><p>nikkie ／ <span class="fab fa-github"></span> <a class="reference external" href="https://github.com/ftnext" rel="noopener noreferrer" target="_blank">@ftnext</a> ／ <a class="reference external" href="https://nikkie-ftnext.hatenablog.com/" rel="noopener noreferrer" target="_blank">ブログ</a> 連続 <strong>650</strong> 日突破</p></li>
<li><p>機械学習エンジニア・自然言語処理（<a class="reference external" href="https://hrmos.co/pages/uzabase/jobs/1829077236709650481" rel="noopener noreferrer" target="_blank">We're hiring!</a>）</p></li>
<li><p>Python歴は6年。PyConで登壇多数</p></li>
</ul>
<img alt="../_images/uzabase-white-logo.png" src="../_images/uzabase-white-logo.png"/>
</section>
<section>
<h3 style="word-break: keep-all; overflow-wrap: break-word;">アンケート（何度でも挙げよう）</h3>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">logging.warning()</span></code> や <code class="docutils literal notranslate"><span class="pre">logging.error()</span></code> したことある🙋‍♂️</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">logging.basicConfig()</span></code> したことある🙋‍♀️</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">logging.getLogger()</span></code> したことある🙋</p></li>
</ul>
</section>
<section>
<h3 style="word-break: keep-all; overflow-wrap: break-word;">本トークの対象者</h3>
<ul class="simple">
<li><p>Pythonのloggingモジュール <strong>触ったことがある</strong></p></li>
<li><p>loggingモジュールの中身はよく分からなくて全然OK👌</p></li>
</ul>
</section>
</section>
<section>
<section>
<h2 style="word-break: keep-all; overflow-wrap: break-word;">皆さんに質問です</h2>
<ul class="simple">
<li><p>あなたはPythonで <code class="docutils literal notranslate"><span class="pre">import</span></code> して使いたいコードを書いています（例：ライブラリ）</p></li>
<li><p>その中で <strong>ロギング</strong> 、どう実装しますか？</p></li>
</ul>
</section>
<section>
<h3 style="word-break: keep-all; overflow-wrap: break-word;">結論：「<code class="docutils literal notranslate"><span class="pre">NullHandler</span></code> 以外はいけません」</h3>
<pre data-id="id8"><code class="python" data-noescape="" data-trim="">import logging

logger = logging.getLogger("mylib")
logger.addHandler(logging.NullHandler())
</code></pre>
<p>公式ドキュメント📄「<a class="reference external" href="https://docs.python.org/ja/3/howto/logging.html#configuring-logging-for-a-library" rel="noopener noreferrer" target="_blank">ライブラリのためのロギングの設定</a>」</p>
</section>
<section>
<h3 style="word-break: keep-all; overflow-wrap: break-word;">すべて公式 <strong>ドキュメント</strong> に書いてあります！</h3>
<ul class="simple">
<li><p>しかし、観測範囲ではPython使いに気づかれていない印象...😫</p></li>
<li><p>📄の付いたリンクは、公式ドキュメントへのリンク</p></li>
<li><p>（別のemoji：🏃‍♂️は本編では飛ばします）</p></li>
</ul>
</section>
<section>
<h3 style="word-break: keep-all; overflow-wrap: break-word;">本トークのメッセージ（Takeaway）</h3>
<ul class="simple">
<li><p>ライブラリ開発者は <em>ロガー</em> を用意し、 <em>何もしないハンドラ</em> を設定しよう</p></li>
<li><p>アプリケーション開発者は <em>ルートロガー</em> を設定し、 <em>propagate</em> を利用してログを表示しよう</p></li>
</ul>
<p>斜体はこのトークで解説します</p>
</section>
<section>
<h3 style="word-break: keep-all; overflow-wrap: break-word;">これらはオススメしません（ぶっぶー🙅‍♂️） 🏃‍♂️</h3>
<pre data-id="id10"><code class="python" data-noescape="" data-trim="">logging.basicConfig()</code></pre>
<pre data-id="id10"><code class="python" data-noescape="" data-trim="">logging.warning()</code></pre>
<pre data-id="id10"><code class="python" data-noescape="" data-trim="">logger = logging.getLogger("mylib")
logger.addHandler(logging.StreamHandler())</code></pre>
<p><code class="docutils literal notranslate"><span class="pre">import</span></code> して使いたいコードでの話です</p>
</section>
</section>
<section>
<section>
<h2 style="word-break: keep-all; overflow-wrap: break-word;">Logging クックブックの「避けるべきパターン」の1つ</h2>
<ul>
<li><p><a class="reference external" href="https://docs.python.org/ja/3/howto/logging-cookbook.html#adding-handlers-other-than-nullhandler-to-a-logger-in-a-library" rel="noopener noreferrer" target="_blank">ライブラリ内でロガーに NullHandler 以外のハンドラーを追加する</a> 📄</p>
<blockquote>
<div><p>(略) ログ出力をカスタマイズするのはライブラリ開発者ではなく、アプリケーション開発者の責務です。</p>
</div></blockquote>
</li>
</ul>
</section>
<section>
<h3 style="word-break: keep-all; overflow-wrap: break-word;">本トークの構成</h3>
<ol class="arabic simple">
<li><p>ライブラリ開発者へ</p></li>
<li><p>アプリケーション開発者へ</p></li>
<li><p>落ち穂拾い</p></li>
</ol>
</section>
</section>
<section>
<section>
<h2 style="word-break: keep-all; overflow-wrap: break-word;">1️⃣ライブラリ開発におけるロギングの実装</h2>
<p>あなたが作るライブラリにロギングをどう仕込むか</p>
</section>
<section>
<h3 style="word-break: keep-all; overflow-wrap: break-word;"><a class="reference external" href="https://docs.python.org/ja/3/howto/logging.html#configuring-logging-for-a-library" rel="noopener noreferrer" target="_blank">ライブラリのためのロギングの設定</a> 📄の2点</h3>
<ol class="arabic simple">
<li><p><code class="docutils literal notranslate"><span class="pre">logging.getLogger(...)</span></code> （ロガー）</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">logger.addHandler(...)</span></code> （ハンドラ）</p></li>
</ol>
<pre data-id="id15"><code class="python" data-noescape="" data-trim="">logging.getLogger("mylib").addHandler(logging.NullHandler())</code></pre>
</section>
<section>
<h3 style="word-break: keep-all; overflow-wrap: break-word;">先行発表：loggingの構成要素（<a class="reference external" href="https://youtu.be/ahaslerbm_g?si=uymzSa4NdoeyqRcU" rel="noopener noreferrer" target="_blank">🎥 <svg aria-hidden="true" height="1.0em" style="display: inline-block; vertical-align: middle; fill: currentColor;" version="1.1" viewbox="0 0 16 16" width="1.0em"><path d="M3.75 2h3.5a.75.75 0 0 1 0 1.5h-3.5a.25.25 0 0 0-.25.25v8.5c0 .138.112.25.25.25h8.5a.25.25 0 0 0 .25-.25v-3.5a.75.75 0 0 1 1.5 0v3.5A1.75 1.75 0 0 1 12.25 14h-8.5A1.75 1.75 0 0 1 2 12.25v-8.5C2 2.784 2.784 2 3.75 2Zm6.854-1h4.146a.25.25 0 0 1 .25.25v4.146a.25.25 0 0 1-.427.177L13.03 4.03 9.28 7.78a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042l3.75-3.75-1.543-1.543A.25.25 0 0 1 10.604 1Z"></path></svg></a>）</h3>
<iframe allowfullscreen="true" class="speakerdeck-iframe" data-ratio="1.7777777777777777" frameborder="0" src="https://speakerdeck.com/player/645f81e8b8144b1ba894a9bf5e78263e?slide=16" style="border: 0px; background: rgba(0, 0, 0, 0.1) padding-box; margin: 0px; padding: 0px; border-radius: 6px; box-shadow: rgba(0, 0, 0, 0.2) 0px 5px 40px; width: 100%; height: auto; aspect-ratio: 560 / 315;" title="Loggingモジュールではじめるログ出力入門 / Introduction to Python Logging"></iframe></section>
</section>
<section>
<section>
<h2 style="word-break: keep-all; overflow-wrap: break-word;">1️⃣-1️⃣ <a class="reference external" href="https://docs.python.org/ja/3/library/logging.html#logging.getLogger" rel="noopener noreferrer" target="_blank">logging.getLogger(...)</a> 📄</h2>
<blockquote>
<div><p>Return a logger with the specified name (略)</p>
</div></blockquote>
<p>「指定された名前のロガーを返す」</p>
</section>
<section>
<h3 style="word-break: keep-all; overflow-wrap: break-word;">ロガー</h3>
<blockquote>
<div><p>ロガーは、アプリケーションコードが直接使うインターフェースを公開します。</p>
</div></blockquote>
<p><a class="reference external" href="https://docs.python.org/ja/3/howto/logging.html#advanced-logging-tutorial" rel="noopener noreferrer" target="_blank">上級ロギングチュートリアル</a> 📄</p>
</section>
<section>
<h3 style="word-break: keep-all; overflow-wrap: break-word;">ロギングのための <strong>インターフェース</strong></h3>
<blockquote>
<div><p>You can access logging functionality by creating a logger via <code class="docutils literal notranslate"><span class="pre">logger</span> <span class="pre">=</span> <span class="pre">getLogger(__name__)</span></code>, and then calling the logger's <code class="docutils literal notranslate"><span class="pre">debug()</span></code>, <code class="docutils literal notranslate"><span class="pre">info()</span></code>, <code class="docutils literal notranslate"><span class="pre">warning()</span></code>, <code class="docutils literal notranslate"><span class="pre">error()</span></code> and <code class="docutils literal notranslate"><span class="pre">critical()</span></code> methods.</p>
</div></blockquote>
<p>「基本 logging チュートリアル」📄の「<a class="reference external" href="https://docs.python.org/ja/3/howto/logging.html#when-to-use-logging" rel="noopener noreferrer" target="_blank">logging を使うとき</a>」</p>
</section>
<section>
<h3 style="word-break: keep-all; overflow-wrap: break-word;">開発者は <strong>ロガーを操作</strong> すればOK</h3>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">getLogger(...)</span></code> でロガーインスタンスを得る</p></li>
<li><p>ロガーインスタンスのメソッドを呼び出してロギング</p></li>
</ul>
<pre data-id="ok"><code class="python" data-noescape="" data-trim="">logger.warning("ちょっとヤバいよ")
logger.error("ヤバイよ。マジヤバイよ")</code></pre>
</section>
</section>
<section>
<section>
<h2 style="word-break: keep-all; overflow-wrap: break-word;">そもそも、なぜロギングする？</h2>
<div class="literal-block-wrapper docutils container" id="id95">
<div class="code-block-caption"><span class="caption-text">ロギングのイメージ</span></div>
<pre><code class="python" data-noescape="" data-trim="">try:
    大事な処理()
except Exception as ex:
    logger.warning("Raised %s", repr(ex))</code></pre>
</div>
</section>
<section>
<h3 style="word-break: keep-all; overflow-wrap: break-word;">開発者は <strong>イベントの発生を記録</strong> する</h3>
<blockquote>
<div><p>ソフトウェアの開発者は、特定のイベントが発生したことを示す logging の呼び出しをコードに加えます。</p>
</div></blockquote>
<p><a class="reference external" href="https://docs.python.org/ja/3/howto/logging.html#basic-logging-tutoriala" rel="noopener noreferrer" target="_blank">基本 logging チュートリアル</a> 📄</p>
</section>
<section>
<h3 style="word-break: keep-all; overflow-wrap: break-word;">イベントには <strong>レベル（重要性）</strong> も含む</h3>
<blockquote>
<div><p>イベントには、開発者がそのイベントに定めた重要性も含まれます。重要性は、レベル (level) や 重大度 (severity) とも呼ばれます。</p>
</div></blockquote>
<p><a class="reference external" href="https://docs.python.org/ja/3/howto/logging.html#basic-logging-tutoriala" rel="noopener noreferrer" target="_blank">基本 logging チュートリアル</a> 📄</p>
</section>
<section>
<h3 style="word-break: keep-all; overflow-wrap: break-word;">ロギングレベル 5つ</h3>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">DEBUG</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">INFO</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">WARNING</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ERROR</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">CRITICAL</span></code></p></li>
</ul>
<p><a class="reference external" href="https://docs.python.org/ja/3/howto/logging.html#when-to-use-logging" rel="noopener noreferrer" target="_blank">logging を使うとき</a> 📄（基本 logging チュートリアル）</p>
</section>
<section>
<h3 style="word-break: keep-all; overflow-wrap: break-word;">ロガーもレベルを持つ</h3>
<ul>
<li><p>ロガーはメソッドを持っていた（＝ロギングのインターフェース）</p></li>
<li><p>ログが記録されるのは、 <strong>ロガーの持つレベル以上</strong> の重要性のイベント</p>
<blockquote>
<div><p>level よりも深刻でないログメッセージは無視されます（<a class="reference external" href="https://docs.python.org/ja/3/library/logging.html#logging.Logger.setLevel" rel="noopener noreferrer" target="_blank">Logger.setLevel</a> 📄）</p>
</div></blockquote>
</li>
</ul>
</section>
<section>
<h3 style="word-break: keep-all; overflow-wrap: break-word;">例：ログが記録される場合</h3>
<p><code class="docutils literal notranslate"><span class="pre">WARNING</span></code> レベルのロガー <code class="docutils literal notranslate"><span class="pre">logger</span></code> は</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">logger.warning()</span></code> は記録する</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">logger.info()</span></code> は記録しない</p></li>
</ul>
</section>
<section>
<h3 style="word-break: keep-all; overflow-wrap: break-word;">ログレコード 🏃‍♂️</h3>
<blockquote>
<div><p>LogRecord インスタンスは、何かをログ記録するたびに Logger によって生成されます。</p>
</div></blockquote>
<p><a class="reference external" href="https://docs.python.org/ja/3/library/logging.html#logrecord-objects" rel="noopener noreferrer" target="_blank">LogRecord オブジェクト</a> 📄</p>
</section>
</section>
<section>
<section>
<h2 style="word-break: keep-all; overflow-wrap: break-word;">ロガーの名前について</h2>
<p><code class="docutils literal notranslate"><span class="pre">getLogger</span></code> に渡す引数の話</p>
</section>
<section>
<h3 style="word-break: keep-all; overflow-wrap: break-word;">ドット（ピリオド）区切り</h3>
<blockquote>
<div><p>ロガー名は、何でも望むものにでき、ロギングされたメッセージが発生した場所を指し示します。（<a class="reference external" href="https://docs.python.org/ja/3/howto/logging.html#advanced-logging-tutorial" rel="noopener noreferrer" target="_blank">上級ロギングチュートリアル</a> 📄）</p>
</div></blockquote>
<pre data-id="id27"><code class="python" data-noescape="" data-trim="">logging.getLogger("spam")
logging.getLogger("spam.ham")</code></pre>
</section>
<section>
<h3 style="word-break: keep-all; overflow-wrap: break-word;">ロガーの親子関係</h3>
<pre data-id="id28"><code class="python" data-noescape="" data-trim="">logger = logging.getLogger("spam.ham")</code></pre>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">spam.ham</span></code> ロガーの <strong>親</strong> にあたるのが <code class="docutils literal notranslate"><span class="pre">spam</span></code> ロガー</p></li>
<li><p>すべてのロガーの親 <em>ルートロガー</em> （<code class="docutils literal notranslate"><span class="pre">logging.getLogger()</span></code>）</p></li>
</ul>
</section>
<section>
<h3 style="word-break: keep-all; overflow-wrap: break-word;">ロガーの親子関係</h3>
<a class="reference internal image-reference" href="../_images/logger-ancestors.drawio.png"><img alt="../_images/logger-ancestors.drawio.png" src="../_images/logger-ancestors.drawio.png" style="width: 433.2px; height: 361.2px;"/></a>
</section>
<section>
<h3 style="word-break: keep-all; overflow-wrap: break-word;"><code class="docutils literal notranslate"><span class="pre">logging.getLogger(__name__)</span></code> 🏃‍♂️</h3>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">__name__</span></code> はモジュールの名前（<a class="reference external" href="https://docs.python.org/ja/3/reference/datamodel.html#modules" rel="noopener noreferrer" target="_blank">3.2.9. モジュール</a> 📄）</p></li>
<li><p>このコードで <strong>モジュールレベルのロガー</strong> インスタンスを得た</p>
<blockquote>
<div><p>ロガー名だけで、どこでイベントのログが取られたか、直感的に明らかになります。（<a class="reference external" href="https://docs.python.org/ja/3/howto/logging.html#advanced-logging-tutorial" rel="noopener noreferrer" target="_blank">上級ロギングチュートリアル</a> 📄）</p>
</div></blockquote>
</li>
</ul>
</section>
<section>
<h3 style="word-break: keep-all; overflow-wrap: break-word;">同名のロガー 🏃‍♂️</h3>
<blockquote>
<div><p>与えられた名前に対して、この関数はどの呼び出しでも同じロガーインスタンスを返します。 (<a class="reference external" href="https://docs.python.org/ja/3/library/logging.html#logging.getLogger" rel="noopener noreferrer" target="_blank">logging.getLogger(...)</a> 📄)</p>
</div></blockquote>
<p>シングルトンなので都度 <code class="docutils literal notranslate"><span class="pre">getLogger</span></code> ！（<a class="reference external" href="https://docs.python.org/ja/3/howto/logging-cookbook.html#using-loggers-as-attributes-in-a-class-or-passing-them-as-parameters" rel="noopener noreferrer" target="_blank">避けるべきパターン</a> 📄も参照）</p>
<pre data-id="id29"><code class="pycon" data-noescape="" data-trim="">&gt;&gt;&gt; logging.getLogger("mylib") is logging.getLogger("mylib")
True</code></pre>
</section>
</section>
<section>
<h2 style="word-break: keep-all; overflow-wrap: break-word;">ロガー まとめ🥟 ここまでで <strong>ロギングできます</strong></h2>
<pre data-id="id30"><code class="python" data-noescape="" data-trim="">import logging

logger = logging.getLogger("mylib")

logger.warning("ちょっとヤバいよ")
</code></pre>
<pre data-id="id30"><code class="txt" data-noescape="" data-trim="">ちょっとヤバいよ</code></pre>
</section>
<section>
<section>
<h2 style="word-break: keep-all; overflow-wrap: break-word;">1️⃣-2️⃣ <code class="docutils literal notranslate"><span class="pre">logger.addHandler(...)</span></code></h2>
<blockquote>
<div><p>ハンドラは、(ロガーによって生成された) ログ記録を適切な送信先に送ります。（<a class="reference external" href="https://docs.python.org/ja/3/howto/logging.html#advanced-logging-tutorial" rel="noopener noreferrer" target="_blank">上級ロギングチュートリアル</a> 📄）</p>
</div></blockquote>
</section>
<section>
<h3 style="word-break: keep-all; overflow-wrap: break-word;">ロガーはハンドラを持つ</h3>
<ul class="simple">
<li><p>1つのロガーが <strong>0個以上のハンドラを持つ</strong></p></li>
<li><p>ハンドラはログレコードを出力先に振り分ける</p></li>
</ul>
<p><a class="reference external" href="https://docs.python.org/ja/3/howto/logging.html#handlers" rel="noopener noreferrer" target="_blank">ハンドラ（上級ロギングチュートリアル）</a> 📄</p>
</section>
<section>
<h3 style="word-break: keep-all; overflow-wrap: break-word;">ログメッセージの流れ 🏃‍♂️</h3>
<pre data-id="id32"><code class="python" data-noescape="" data-trim="">logger.warning("&lt;ログメッセージ&gt;")</code></pre>
<ul class="simple">
<li><p>開発者はロガーのメソッドを呼び出してイベントを記録</p></li>
<li><p>ロガーの持つレベル以上の呼び出しのとき、ロガーは <strong>ログレコード</strong> を作成</p></li>
<li><p>ロガーはハンドラにログレコードを渡し、ハンドラがログを出力</p></li>
</ul>
</section>
<section>
<h3 style="word-break: keep-all; overflow-wrap: break-word;">ログの出力先に応じたハンドラ</h3>
<ul class="simple">
<li><p>ストリーム <a class="reference external" href="https://docs.python.org/ja/3/library/logging.handlers.html#logging.StreamHandler" rel="noopener noreferrer" target="_blank">StreamHandler</a></p></li>
<li><p>ファイル <a class="reference external" href="https://docs.python.org/ja/3/library/logging.handlers.html#logging.FileHandler" rel="noopener noreferrer" target="_blank">FileHandler</a></p></li>
<li><p>まだまだあります：<a class="reference external" href="https://docs.python.org/ja/3/howto/logging.html#useful-handlers" rel="noopener noreferrer" target="_blank">便利なハンドラ</a> 📄（ログファイルのローテーションなど）</p></li>
</ul>
</section>
</section>
<section>
<section>
<h2 style="word-break: keep-all; overflow-wrap: break-word;">先のコードはなぜロギングできたか</h2>
<pre data-id="id34"><code class="python" data-noescape="" data-trim="">import logging

logger = logging.getLogger("mylib")

logger.warning("ちょっとヤバいよ")
</code></pre>
</section>
<section>
<h3 style="word-break: keep-all; overflow-wrap: break-word;">ハンドラを指定しないとき</h3>
<blockquote>
<div><p>イベントは、 lastResort に格納された「最終手段ハンドラ」を使用して出力されます。</p>
</div></blockquote>
<p><a class="reference external" href="https://docs.python.org/ja/3/howto/logging.html#what-happens-if-no-configuration-is-provided" rel="noopener noreferrer" target="_blank">環境設定が与えられないとどうなるか</a> 📄</p>
</section>
<section>
<h3 style="word-break: keep-all; overflow-wrap: break-word;"><strong>最終手段ハンドラ</strong> によるログ出力</h3>
<pre data-id="id36"><code class="txt" data-noescape="" data-trim="">ちょっとヤバいよ</code></pre>
<ul class="simple">
<li><p>warning以上のログメッセージが、標準エラー出力に表示される</p></li>
<li><p>フォーマットはなし</p></li>
</ul>
</section>
<section>
<h3 style="word-break: keep-all; overflow-wrap: break-word;">常に最終手段ハンドラを使わなきゃいけない？</h3>
<blockquote>
<div><p>何らかの理由でロギング設定がなされていないときにメッセージを表示 させたくない のであれば、ライブラリのトップレベルのロガーに何もしないハンドラを取り付けられます。</p>
</div></blockquote>
<p><a class="reference external" href="https://docs.python.org/ja/3/howto/logging.html#configuring-logging-for-a-library" rel="noopener noreferrer" target="_blank">ライブラリのためのロギングの設定</a> 📄</p>
</section>
</section>
<section>
<section>
<h2 style="word-break: keep-all; overflow-wrap: break-word;"><code class="docutils literal notranslate"><span class="pre">NullHandler</span></code></h2>
<ul class="simple">
<li><p><strong>何もしない</strong> ハンドラ</p></li>
</ul>
<p><a class="reference external" href="https://docs.python.org/ja/3/library/logging.handlers.html#logging.NullHandler" rel="noopener noreferrer" target="_blank">https://docs.python.org/ja/3/library/logging.handlers.html#logging.NullHandler</a></p>
</section>
<section>
<h3 style="word-break: keep-all; overflow-wrap: break-word;">最終手段ハンドラの出番にはしたくない</h3>
<ul class="simple">
<li><p>ライブラリのロガーになにかハンドラを持たせよう</p></li>
<li><p><strong>何もしないハンドラ</strong> （<code class="docutils literal notranslate"><span class="pre">NullHandler</span></code>）の出番！</p></li>
</ul>
<p><a class="reference external" href="https://docs.python.org/ja/3/howto/logging.html#configuring-logging-for-a-library" rel="noopener noreferrer" target="_blank">ライブラリのためのロギングの設定</a> 📄</p>
</section>
<section>
<h3 style="word-break: keep-all; overflow-wrap: break-word;">最終手段ハンドラの出番はなく、ログ出力はない</h3>
<pre data-id="id40"><code class="python" data-noescape="" data-trim="">import logging

logger = logging.getLogger("mylib")
logger.addHandler(logging.NullHandler())

logger.warning("ちょっとヤバいよ")
</code></pre>
</section>
</section>
<section>
<h2 style="word-break: keep-all; overflow-wrap: break-word;">まとめ🥟 ライブラリ開発におけるロギングの実装</h2>
<pre data-id="id41"><code class="python" data-noescape="" data-trim="">logging.getLogger("mylib").addHandler(logging.NullHandler())</code></pre>
<ul class="simple">
<li><p>あなたのライブラリ用のロガーインスタンスを得よう</p></li>
<li><p>最終手段ハンドラを望まない場合、 <code class="docutils literal notranslate"><span class="pre">NullHandler</span></code> を持たせよう</p></li>
</ul>
</section>
<section>
<section>
<h2 style="word-break: keep-all; overflow-wrap: break-word;">2️⃣アプリケーション開発におけるロギングの実装</h2>
<p>ロギングが仕込まれたライブラリをどう使うか</p>
</section>
<section>
<h3 style="word-break: keep-all; overflow-wrap: break-word;">アプリケーション開発者がログ出力を <strong>カスタマイズ</strong>！</h3>
<blockquote>
<div><p>ハンドラーやフォーマッター (略) を追加してログ出力をカスタマイズするのは (略)、アプリケーション開発者の責務です。</p>
</div></blockquote>
<p><a class="reference external" href="https://docs.python.org/ja/3/howto/logging-cookbook.html#adding-handlers-other-than-nullhandler-to-a-logger-in-a-library" rel="noopener noreferrer" target="_blank">ライブラリ内でロガーに NullHandler 以外のハンドラーを追加する</a> 📄（再掲）</p>
</section>
<section>
<h3 style="word-break: keep-all; overflow-wrap: break-word;">ログ出力のカスタマイズ 2通り</h3>
<ol class="arabic simple">
<li><p><strong>ルートロガーを設定</strong> （👈主な話題）</p></li>
<li><p>ライブラリのロガーを触る</p></li>
</ol>
</section>
</section>
<section>
<section>
<h2 style="word-break: keep-all; overflow-wrap: break-word;">ルートロガーを設定する</h2>
<p>アプリケーション開発者に提供される手段が <code class="docutils literal notranslate"><span class="pre">logging.basicConfig()</span></code></p>
</section>
<section>
<h3 style="word-break: keep-all; overflow-wrap: break-word;"><a class="reference external" href="https://docs.python.org/ja/3/library/logging.html#logging.basicConfig" rel="noopener noreferrer" target="_blank">logging.basicConfig()</a> 📄</h3>
<blockquote>
<div><p>デフォルトの Formatter を持つ StreamHandler を生成してルートロガーに追加し、ロギングシステムの基本的な環境設定を行います。</p>
</div></blockquote>
</section>
<section>
<h3 style="word-break: keep-all; overflow-wrap: break-word;"><code class="docutils literal notranslate"><span class="pre">logging.basicConfig()</span></code> に関わる概念</h3>
<ul class="simple">
<li><p>ロギングレベル</p></li>
<li><p>フォーマッタ</p></li>
</ul>
<p>他の要素は公式ドキュメントをどうぞ</p>
</section>
<section>
<h3 style="word-break: keep-all; overflow-wrap: break-word;">ルートロガーのレベルを設定</h3>
<pre data-id="id49"><code class="python" data-noescape="" data-trim="">logging.basicConfig(level=logging.WARNING)</code></pre>
<ul class="simple">
<li><p>loggingでは、ロガーの持つレベル以上の重要性のイベントがログに記録される（再掲）</p></li>
</ul>
</section>
<section>
<h3 style="word-break: keep-all; overflow-wrap: break-word;">フォーマッタ</h3>
<pre data-id="id50"><code class="python" data-noescape="" data-trim="">logging.basicConfig(format="%(levelname)s:%(name)s:%(message)s")</code></pre>
<ul class="simple">
<li><p>ハンドラは1つのフォーマッタを持つ</p></li>
<li><p>ハンドラの出力に適用される <strong>書式の設定</strong></p></li>
</ul>
</section>
<section>
<h3 style="word-break: keep-all; overflow-wrap: break-word;">書式設定に使える属性名 🏃‍♂️</h3>
<pre data-id="id51"><code class="python" data-noescape="" data-trim="">format="%(asctime)s | %(levelname)s | %(name)s:%(funcName)s:%(lineno)d - %(message)s"</code></pre>
<p><a class="reference external" href="https://docs.python.org/ja/3/library/logging.html#logrecord-attributes" rel="noopener noreferrer" target="_blank">LogRecord 属性</a> 📄</p>
</section>
<section>
<h3 style="word-break: keep-all; overflow-wrap: break-word;">ルートロガーをカスタマイズ</h3>
<p>アプリケーション開発者 <strong>（ライブラリを使う側）が好きに</strong> 決められます</p>
<ul class="simple">
<li><p>ロギングレベル</p></li>
<li><p>ハンドラ &amp; フォーマッタ</p></li>
</ul>
</section>
</section>
<section>
<section>
<h2 style="word-break: keep-all; overflow-wrap: break-word;">ルートロガーを設定してライブラリのログを出力</h2>
<p><strong>propagate</strong> （伝播）</p>
</section>
<section>
<h3 style="word-break: keep-all; overflow-wrap: break-word;">ロガーの <a class="reference external" href="https://docs.python.org/ja/3/library/logging.html#logging.Logger.propagate" rel="noopener noreferrer" target="_blank">propagate</a> 属性📄</h3>
<blockquote>
<div><p>この属性が真と評価された場合、このロガーに記録されたイベントは、このロガーに取り付けられた全てのハンドラに加え、上位 (祖先) ロガーのハンドラにも渡されます。</p>
</div></blockquote>
</section>
<section>
<h3 style="word-break: keep-all; overflow-wrap: break-word;">ロガーの親子関係（再び）</h3>
<a class="reference internal image-reference" href="../_images/logger-ancestors-part.drawio.png"><img alt="../_images/logger-ancestors-part.drawio.png" src="../_images/logger-ancestors-part.drawio.png" style="width: 385.2px; height: 361.2px;"/></a>
</section>
<section>
<h3 style="word-break: keep-all; overflow-wrap: break-word;">propagate（伝播）</h3>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">spam</span></code> ロガーのロギングレベル以上のメソッドが呼ばれた</p>
<blockquote>
<div><ul class="simple">
<li><p>例：ロガーのレベルは <code class="docutils literal notranslate"><span class="pre">WARNING</span></code> で、 <code class="docutils literal notranslate"><span class="pre">warning()</span></code> メソッドが呼ばれた</p></li>
</ul>
</div></blockquote>
</li>
<li><p>そのログレコードは <strong>親のロガーに伝播</strong> し、親のハンドラにも渡る</p></li>
</ul>
</section>
<section>
<h3 style="word-break: keep-all; overflow-wrap: break-word;">📌 <code class="docutils literal notranslate"><span class="pre">NullHandler</span></code> + <code class="docutils literal notranslate"><span class="pre">basicConfig</span></code> + propagate</h3>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">mylib</span></code> ロガーのロギングレベル以上のメソッドが呼ばれた</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">mylib</span></code> ロガーのハンドラ（<code class="docutils literal notranslate"><span class="pre">NullHandler</span></code>）が処理（するが出力はない）</p></li>
<li><p>親のルートロガーに伝播し、 <strong>ルートロガーのハンドラで処理して出力される</strong></p></li>
</ul>
</section>
<section>
<h3 style="word-break: keep-all; overflow-wrap: break-word;">ドキュメント <a class="reference external" href="https://docs.python.org/ja/3/library/logging.html#logging.Logger.propagate" rel="noopener noreferrer" target="_blank">propagate</a> の注釈📄より</h3>
<blockquote>
<div><p>一般的なシナリオでは、ハンドラをルートロガーに対してのみ接続し、残りは propagate にすべて委ねます。</p>
</div></blockquote>
</section>
<section>
<h3 style="word-break: keep-all; overflow-wrap: break-word;"><a class="reference external" href="`https://docs.python.org/ja/3/howto/logging.html#loggers`" rel="noopener noreferrer" target="_blank">ロガー</a> 📄（上級ロギングチュートリアル）🏃‍♂️</h3>
<blockquote>
<div><p>子ロガーはメッセージを親ロガーのハンドラに伝えます。(略) トップレベルのロガーのためのハンドラだけ設定しておいて必要に応じて子ロガーを作成すれば十分です。</p>
</div></blockquote>
</section>
</section>
<section>
<section>
<h2 style="word-break: keep-all; overflow-wrap: break-word;">待って🤚 ライブラリのロガーのレベルって？</h2>
<p>今一度 <strong>ライブラリ開発者向け</strong> の話になります</p>
</section>
<section>
<h3 style="word-break: keep-all; overflow-wrap: break-word;"><code class="docutils literal notranslate"><span class="pre">NullHandler</span></code> 以外はいけません（結論・再掲）</h3>
<pre data-id="id61"><code class="python" data-noescape="" data-trim="">import logging

logger = logging.getLogger("mylib")
logger.addHandler(logging.NullHandler())
</code></pre>
<p>ライブラリのロガーに <strong>ロギングレベルは設定していない</strong></p>
</section>
<section>
<h3 style="word-break: keep-all; overflow-wrap: break-word;">ロギングレベル <code class="docutils literal notranslate"><span class="pre">NOTSET</span></code></h3>
<blockquote>
<div><p>ロガーが生成された際、レベルは NOTSET (略) に設定されます。</p>
</div></blockquote>
<p><a class="reference external" href="https://docs.python.org/ja/3/library/logging.html#logging.Logger.setLevel" rel="noopener noreferrer" target="_blank">Logger.setLevel</a> 📄より</p>
</section>
<section>
<h3 style="word-break: keep-all; overflow-wrap: break-word;"><code class="docutils literal notranslate"><span class="pre">NOTSET</span></code> とは</h3>
<blockquote>
<div><p>もしロガーのレベルが NOTSET ならば、祖先ロガーの系列の中を NOTSET 以外のレベルの祖先を見つけるかルートに到達するまで辿っていく</p>
</div></blockquote>
<p><a class="reference external" href="https://docs.python.org/ja/3/library/logging.html#logging.Logger.setLevel" rel="noopener noreferrer" target="_blank">Logger.setLevel</a> 📄より（「<em>親ロガーに委譲</em>」）</p>
</section>
<section>
<h3 style="word-break: keep-all; overflow-wrap: break-word;">ライブラリのロガーにロギングレベルを設定したいとき</h3>
<ul class="simple">
<li><p>親をそのまた親へとたどっていき、最初に見つかった <code class="docutils literal notranslate"><span class="pre">NOTSET</span></code> 以外のレベルになる、ということ（<a class="reference external" href="https://docs.python.org/ja/3/library/logging.html#logging-levels" rel="noopener noreferrer" target="_blank">ロギングレベル</a> 📄）</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">mylib</span></code> ロガーは、親の <strong>ルートロガーに設定したレベル</strong> となる！</p></li>
</ul>
</section>
<section>
<h3 style="word-break: keep-all; overflow-wrap: break-word;">拙ブログより ロギングレベル <code class="docutils literal notranslate"><span class="pre">NOTSET</span></code> 🏃‍♂️</h3>
<ul class="simple">
<li><p><a class="reference external" href="https://nikkie-ftnext.hatenablog.com/entry/python-configuring-logging-for-library-log-level-notset" rel="noopener noreferrer" target="_blank">自作のPythonライブラリでloggingを使うとき、ロガーにsetLevelしない？ ログレベルNOTSETのロガーの動きを理解する</a></p></li>
<li><p><a class="reference external" href="https://nikkie-ftnext.hatenablog.com/entry/python-logger-repr-effective-level" rel="noopener noreferrer" target="_blank">Pythonの対話モードで確認できるロガーのレベルは、ロガーが持つレベルそのものではなく、実効（effective）レベル</a></p></li>
</ul>
</section>
</section>
<section>
<section>
<h2 style="word-break: keep-all; overflow-wrap: break-word;">propagate まとめ🥟 ライブラリのロギング</h2>
<pre data-id="id65"><code class="python" data-noescape="" data-trim="">import logging

logger = logging.getLogger("mylib")
logger.addHandler(logging.NullHandler())


def awesome():
    logger.info("想定通り")
</code></pre>
</section>
<section>
<h3 style="word-break: keep-all; overflow-wrap: break-word;">例：ルートロガーのロギングレベルが <code class="docutils literal notranslate"><span class="pre">WARNING</span></code> だと出力されない</h3>
<pre data-id="warning"><code class="python" data-line-numbers="5" data-noescape="" data-trim="">import logging

from mylib import awesome

logging.basicConfig(level=logging.WARNING)

awesome()
</code></pre>
<p><code class="docutils literal notranslate"><span class="pre">mylib</span></code> ロガーも <code class="docutils literal notranslate"><span class="pre">WARNING</span></code> レベル</p>
</section>
<section>
<h3 style="word-break: keep-all; overflow-wrap: break-word;">例：ルートロガーのロギングレベルが <code class="docutils literal notranslate"><span class="pre">DEBUG</span></code> だと <strong>出力される</strong></h3>
<pre data-id="debug"><code class="python" data-line-numbers="5" data-noescape="" data-trim="">import logging

from mylib import awesome

logging.basicConfig(level=logging.DEBUG)

awesome()
</code></pre>
<pre data-id="debug"><code class="txt" data-noescape="" data-trim="">INFO:mylib:想定通り</code></pre>
<p><code class="docutils literal notranslate"><span class="pre">mylib</span></code> ロガーも <code class="docutils literal notranslate"><span class="pre">DEBUG</span></code> レベル</p>
</section>
<section>
<h3 style="word-break: keep-all; overflow-wrap: break-word;"><strong>違いはルートロガーのロギングレベル</strong></h3>
<ul class="simple">
<li><p>ライブラリのコードは同じ</p></li>
<li><p>ライブラリのロガーはレベル <code class="docutils literal notranslate"><span class="pre">NOTSET</span></code> で、ルートロガーのレベルを参照</p></li>
<li><p>ライブラリを利用するアプリケーションコードでカスタマイズした</p></li>
</ul>
</section>
</section>
<section>
<section>
<h2 style="word-break: keep-all; overflow-wrap: break-word;">まとめ🥟 アプリケーション開発におけるロギングの実装</h2>
<pre data-id="id67"><code class="python" data-noescape="" data-trim="">logging.basicConfig(level=logging.DEBUG, format="%(levelname)s:%(name)s:%(message)s")</code></pre>
<ul class="simple">
<li><p>ライブラリを使う側の都合で、ルートロガーを設定</p></li>
<li><p>ライブラリのロガーはルートロガーのレベルを参照し、propagateで <strong>ルートロガーのハンドラでログ出力</strong></p></li>
</ul>
</section>
<section>
<h3 style="word-break: keep-all; overflow-wrap: break-word;">propagateは <strong>親ロガーのレベルによらない</strong> 🏃‍♂️</h3>
<blockquote>
<div><p>メッセージは、祖先ロガーのハンドラに直接渡されます - 今問題にしている祖先ロガーのレベルもフィルタも、どちらも考慮されません。</p>
</div></blockquote>
<p><a class="reference external" href="https://docs.python.org/ja/3/library/logging.html#logging.Logger.propagate" rel="noopener noreferrer" target="_blank">propagate</a></p>
</section>
<section>
<h3 style="word-break: keep-all; overflow-wrap: break-word;">propagateで祖先ロガーのレベルが考慮されない例 🏃‍♂️</h3>
<pre data-id="id69"><code class="python" data-noescape="" data-trim="">import logging

logging.basicConfig(
    level=logging.WARNING,
    format="%(asctime)s | %(levelname)s | %(name)s:%(funcName)s:%(lineno)d - %(message)s",
)

logger = logging.getLogger("mylib")
logger.setLevel(logging.INFO)

logger.info("想定通り")
</code></pre>
<pre data-id="id69"><code class="txt" data-noescape="" data-trim="">2024-08-29 21:42:01,945 | INFO | mylib:&lt;module&gt;:11 - 想定通り
</code></pre>
</section>
<section>
<h3 style="word-break: keep-all; overflow-wrap: break-word;">ライブラリのロガーを触ってログ出力をカスタマイズ 🏃‍♂️</h3>
<ul class="simple">
<li><p>アプリケーションコードで <code class="docutils literal notranslate"><span class="pre">getLogger("mylib")</span></code> し、レベル・ハンドラ・フォーマッタを設定</p></li>
<li><p>拙ブログ <a class="reference external" href="https://nikkie-ftnext.hatenablog.com/entry/configure-python-librarys-logger" rel="noopener noreferrer" target="_blank">Pythonのライブラリに用意されたロガーを設定してログを出力する（httpxを例に）</a></p></li>
</ul>
</section>
</section>
<section>
<h2 style="word-break: keep-all; overflow-wrap: break-word;">3️⃣落ち穂拾い</h2>
<ul class="simple">
<li><p>ライブラリで <code class="docutils literal notranslate"><span class="pre">NullHandler</span></code> を使わない（アンチパターン）</p></li>
<li><p>Logging Flow</p></li>
</ul>
</section>
<section>
<section>
<h2 style="word-break: keep-all; overflow-wrap: break-word;">3️⃣-1️⃣ ライブラリのロギングのアンチパターン</h2>
<p>なぜ「<code class="docutils literal notranslate"><span class="pre">NullHandler</span></code> 以外はいけません」なのか</p>
</section>
<section>
<h3 style="word-break: keep-all; overflow-wrap: break-word;">⚠️ <code class="docutils literal notranslate"><span class="pre">NullHandler</span></code> 以外のハンドラを設定してみる</h3>
<pre data-id="id73"><code class="python" data-line-numbers="4" data-noescape="" data-trim="">import logging

logger = logging.getLogger("mylib")
logger.addHandler(logging.StreamHandler())</code></pre>
</section>
<section>
<h3 style="word-break: keep-all; overflow-wrap: break-word;">2重出力😱</h3>
<pre data-id="id74"><code class="python" data-noescape="" data-trim="">logging.basicConfig(
    level=logging.DEBUG,
    format="%(asctime)s | %(levelname)s | %(name)s:%(funcName)s:%(lineno)d - %(message)s",
)</code></pre>
<pre data-id="id74"><code class="txt" data-noescape="" data-trim="">想定通り
2024-08-31 14:16:34,968 | INFO | antipattern_logging.add_non_nullhandler:awesome:8 - 想定通り</code></pre>
</section>
<section>
<h3 style="word-break: keep-all; overflow-wrap: break-word;">2重出力の裏にpropagate</h3>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">mylib</span></code> ロガーのロギングレベル以上のメソッドが呼ばれた</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">mylib</span></code> ロガーのハンドラ（<code class="docutils literal notranslate"><span class="pre">StreamHandler</span></code>）が処理して出力</p></li>
<li><p>親のルートロガーに伝播し、 <strong>ルートロガーのハンドラでも処理</strong> して出力</p></li>
</ul>
</section>
<section>
<h3 style="word-break: keep-all; overflow-wrap: break-word;"><a class="reference external" href="https://docs.python.org/ja/3/howto/logging.html#configuring-logging-for-a-library" rel="noopener noreferrer" target="_blank">ライブラリのためのロギングの設定</a> の注釈📄</h3>
<blockquote>
<div><p>ライブラリのロガーには、 NullHandler 以外のハンドラを追加しない ことを強く推奨します。これは、ハンドラの設定が、あなたのライブラリを使うアプリケーション開発者にも伝播するからです。</p>
</div></blockquote>
</section>
</section>
<section>
<section>
<h2 style="word-break: keep-all; overflow-wrap: break-word;">もう1例：ライブラリがルートロガーを触る</h2>
<p>これもやってはいけません</p>
</section>
<section>
<h3 style="word-break: keep-all; overflow-wrap: break-word;">⚠️ ライブラリで <code class="docutils literal notranslate"><span class="pre">basicConfig()</span></code></h3>
<pre data-id="basicconfig"><code class="python" data-noescape="" data-trim="">import logging

logging.basicConfig(
    level=logging.DEBUG, format="%(levelname)s:%(name)s:%(message)s"
)</code></pre>
</section>
<section>
<h3 style="word-break: keep-all; overflow-wrap: break-word;"><code class="docutils literal notranslate"><span class="pre">basicConfig()</span></code> がルートロガーを設定するのは「一度だけ」</h3>
<blockquote>
<div><p>(略) ルートロガーに設定されたハンドラがあれば何もしません。(<a class="reference external" href="https://docs.python.org/ja/3/library/logging.html#logging.basicConfig" rel="noopener noreferrer" target="_blank">logging.basicConfig()</a> 📄)</p>
</div></blockquote>
<p>ライブラリがルートロガーにハンドラを設定してしまうと、 <strong>アプリケーションコードで呼び出しても何も起こらない</strong> 😭（詳しくは <a class="reference external" href="https://nikkie-ftnext.hatenablog.com/entry/python-logging-basicconfig-configure-root-logger-without-handler" rel="noopener noreferrer" target="_blank">ブログ記事</a> に）</p>
</section>
<section>
<h3 style="word-break: keep-all; overflow-wrap: break-word;"><strong>ライブラリではルートロガーは触らない</strong></h3>
<blockquote>
<div><p>あなたのライブラリから ルートロガーへ直接ログを記録しない ことを強く推奨します。</p>
</div></blockquote>
<p><a class="reference external" href="https://docs.python.org/ja/3/howto/logging.html#configuring-logging-for-a-library" rel="noopener noreferrer" target="_blank">ライブラリのためのロギングの設定</a> 📄</p>
</section>
<section>
<h3 style="word-break: keep-all; overflow-wrap: break-word;"><code class="docutils literal notranslate"><span class="pre">logging.warning()</span></code> なども全部 <code class="docutils literal notranslate"><span class="pre">basicConfig()</span></code> を呼んでます</h3>
<blockquote>
<div><p>if the root logger has no handlers, then <code class="docutils literal notranslate"><span class="pre">basicConfig()</span></code> is called, prior to calling debug on the root logger. (📄 <a class="reference external" href="https://docs.python.org/ja/3/library/logging.html#logging.debug" rel="noopener noreferrer" target="_blank">logging.debug()</a>)</p>
</div></blockquote>
<p><code class="docutils literal notranslate"><span class="pre">basicConfig()</span></code> 同様にライブラリで使ってはいけません</p>
</section>
</section>
<section>
<section>
<h2 style="word-break: keep-all; overflow-wrap: break-word;">3️⃣-2️⃣ Logging Flow</h2>
<p><a class="reference external" href="https://docs.python.org/ja/3/howto/logging.html#logging-flow" rel="noopener noreferrer" target="_blank">Logging Flow</a> 📄を読み解く</p>
</section>
<section>
<h3 style="word-break: keep-all; overflow-wrap: break-word;">Pythonのloggingの構成要素</h3>
<ul class="simple">
<li><p>ロガー</p></li>
<li><p>ロギングレベル</p></li>
<li><p>ハンドラ</p></li>
<li><p>フォーマッタ</p></li>
<li><p><strong>フィルタ</strong> （👉 <em>Appendix</em>）</p></li>
</ul>
</section>
<section>
<h3 style="word-break: keep-all; overflow-wrap: break-word;">ロガーを構成する要素</h3>
<ul class="simple">
<li><p>ロギングレベル</p></li>
<li><p>ハンドラ（0個以上）</p></li>
<li><p><em>フィルタ</em> （0個以上）</p></li>
</ul>
</section>
<section>
<h3 style="word-break: keep-all; overflow-wrap: break-word;">ハンドラを構成する要素</h3>
<ul class="simple">
<li><p><em>ロギングレベル</em> （👉 <em>Appendix</em>）</p></li>
<li><p>フォーマッタ（1個）</p></li>
<li><p><em>フィルタ</em> （0個以上）</p></li>
</ul>
</section>
<section>
<h3 style="word-break: keep-all; overflow-wrap: break-word;">なぜこんなに構成要素がある？</h3>
<ul>
<li><p><strong>柔軟なロギング</strong> を提供</p></li>
<li><p>例：ロガーに複数のハンドラを設定。ハンドラのロギングレベルを使って、レベルごとに異なる出力先へ出し分ける</p>
<blockquote>
<div><p>それぞれのハンドラで設定されるレベルは、そのハンドラがどのメッセージを転送するべきか決めます。(<a class="reference external" href="https://docs.python.org/ja/3/howto/logging.html#handlers" rel="noopener noreferrer" target="_blank">ハンドラ（上級ロギングチュートリアル）</a> 📄)</p>
</div></blockquote>
</li>
</ul>
</section>
</section>
<section>
<section>
<h2 style="word-break: keep-all; overflow-wrap: break-word;"><a class="reference external" href="https://docs.python.org/ja/3/howto/logging.html#logging-flow" rel="noopener noreferrer" target="_blank">Logging Flow</a></h2>
<p>構成要素がどのように組み合さって動くかを示す</p>
</section>
<section>
<h3 style="word-break: keep-all; overflow-wrap: break-word;">一例：propagate（ただし抜粋）</h3>
<ul class="simple">
<li><p>ライブラリのロガーのレベル以上の呼び出し</p></li>
<li><p>そのロガーのハンドラがログレコードを処理</p></li>
<li><p>ライブラリのロガーの親のハンドラにもログレコードが渡る（親のレベルは見ない）</p></li>
</ul>
</section>
</section>
<section>
<section>
<h2 style="word-break: keep-all; overflow-wrap: break-word;">まとめ🌯 ライブラリ開発者に贈る「ロギングで <code class="docutils literal notranslate"><span class="pre">NullHandler</span></code> 以外はいけません」</h2>
</section>
<section>
<pre data-id="id86"><code class="python" data-noescape="" data-trim="">import logging

logger = logging.getLogger("mylib")
logger.addHandler(logging.NullHandler())
</code></pre>
<p>📣ライブラリのユーザが自由にロギングをカスタマイズできるようにしよう</p>
<ul class="simple">
<li><p>そのための <code class="docutils literal notranslate"><span class="pre">NullHandler</span></code></p></li>
<li><p>propagateを使って、 <strong>ユーザが設定するルートロガーのハンドラでログ出力</strong></p></li>
</ul>
</section>
<section>
<h3 style="word-break: keep-all; overflow-wrap: break-word;">メッセージ（Takeaway）再掲 🏃‍♂️</h3>
<ul class="simple">
<li><p>ライブラリ開発者はロガーを用意し、 <strong>何もしないハンドラを設定</strong> しよう</p></li>
<li><p>アプリケーション開発者はルートロガーを設定し、 <strong>propagateを利用してログを表示</strong> しよう</p></li>
</ul>
</section>
<section>
<h3 style="word-break: keep-all; overflow-wrap: break-word;">ご清聴ありがとうございました</h3>
<p>Enjoy Python logging❤️</p>
</section>
</section>
<section>
<h2 style="word-break: keep-all; overflow-wrap: break-word;">Appendix</h2>
</section>
<section>
<h2 style="word-break: keep-all; overflow-wrap: break-word;">ハンドラのロギングレベル</h2>
<ul>
<li><p>結論のコード、<code class="docutils literal notranslate"><span class="pre">NullHandler</span></code> のレベルは NOTSET</p>
<blockquote>
<div><p>ハンドラが生成された際、レベルは NOTSET (すべてのメッセージが処理される) に設定されます。</p>
</div></blockquote>
</li>
</ul>
<p><a class="reference external" href="https://docs.python.org/ja/3/library/logging.html#logging.Handler.setLevel" rel="noopener noreferrer" target="_blank">Handler.setLevel</a> 📄</p>
</section>
<section>
<section>
<h2 style="word-break: keep-all; overflow-wrap: break-word;">フィルタ</h2>
<ul class="simple">
<li><p>ロガーやハンドラに取り付けられる</p></li>
</ul>
<p><a class="reference external" href="https://docs.python.org/ja/3/library/logging.html#filter" rel="noopener noreferrer" target="_blank">https://docs.python.org/ja/3/library/logging.html#filter</a></p>
</section>
<section>
<h3 style="word-break: keep-all; overflow-wrap: break-word;">フィルタは何をするのか</h3>
<blockquote>
<div><p>(略) name はロガーの名前を表します。指定されたロガーとその子ロガーのイベントがフィルタを通過できるようになります。(<a class="reference external" href="https://docs.python.org/ja/3/library/logging.html#logging.Filter" rel="noopener noreferrer" target="_blank">logging.Filter()</a> 📄)</p>
</div></blockquote>
<p>ロガーの階層構造が関係</p>
</section>
<section>
<h3 style="word-break: keep-all; overflow-wrap: break-word;">例： <code class="docutils literal notranslate"><span class="pre">logging.Filter("A.B")</span></code></h3>
<blockquote>
<div><p>例えば、'A.B' で初期化されたフィルタは、ロガー 'A.B', 'A.B.C', 'A.B.C.D', 'A.B.D' 等によって記録されたイベントは許可しますが、'A.BB', 'B.A.B' などは許可しません。</p>
</div></blockquote>
<p><a class="reference external" href="https://docs.python.org/ja/3/library/logging.html#filter" rel="noopener noreferrer" target="_blank">フィルタオブジェクト</a> 📄</p>
</section>
</section>
<section>
<h2 style="word-break: keep-all; overflow-wrap: break-word;">環境設定（このトークではスコープアウト）</h2>
<ul class="simple">
<li><p><a class="reference external" href="https://docs.python.org/ja/3/library/logging.config.html" rel="noopener noreferrer" target="_blank">logging.config</a> 📄</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">dictConfig</span></code> や <code class="docutils literal notranslate"><span class="pre">fileConfig</span></code></p></li>
<li><p>最初に読むなら『<a class="reference external" href="https://gihyo.jp/book/2022/978-4-297-12576-9" rel="noopener noreferrer" target="_blank">Python実践レシピ</a>』17.4</p></li>
</ul>
</section>
<section>
<section>
<h2 style="word-break: keep-all; overflow-wrap: break-word;">これまでのlogging関連アウトプット</h2>
</section>
<section>
<h3 style="word-break: keep-all; overflow-wrap: break-word;">2023年3月みんなのPython勉強会（資料公開のみ）</h3>
<iframe height="480" src="https://ftnext.github.io/2023-slides/stapy-march/logging-introduction.html" title="Pythonのlogging入門" width="800"></iframe></section>
<section>
<h3 style="word-break: keep-all; overflow-wrap: break-word;">拙ブログより、logging関連エントリ 1/4</h3>
<ul class="simple">
<li><p><a class="reference external" href="https://nikkie-ftnext.hatenablog.com/entry/python-logging-root-logger-and-chain-propagation" rel="noopener noreferrer" target="_blank">Pythonのloggingを よ う や く 完全に理解しました 〜revChatGPTでdebugレベルログを出そうとした試行錯誤を題材に〜</a></p></li>
<li><p><a class="reference external" href="https://nikkie-ftnext.hatenablog.com/entry/python-logging-the-simplest-example-under-the-hood" rel="noopener noreferrer" target="_blank">Pythonのloggingモジュールのドキュメントの「もっとも単純な例」を説明する 〜logging.warningの裏側で起こっていること〜</a></p></li>
</ul>
</section>
<section>
<h3 style="word-break: keep-all; overflow-wrap: break-word;">拙ブログより、logging関連エントリ 2/4</h3>
<ul class="simple">
<li><p><a class="reference external" href="https://nikkie-ftnext.hatenablog.com/entry/python-logging-filter-with-propagation-too-difficult" rel="noopener noreferrer" target="_blank">Pythonのloggingモジュールで、ロガーのフィルタと、ロガーのハンドラのフィルタとで、伝播されたログに対する挙動が違うことにハマりました</a></p></li>
<li><p><a class="reference external" href="https://nikkie-ftnext.hatenablog.com/entry/python-logging-handwriting-logging-flow" rel="noopener noreferrer" target="_blank">Pythonのloggingモジュールのチュートリアルの中のフローチャートを、理解を深めるために写経する</a></p></li>
</ul>
</section>
<section>
<h3 style="word-break: keep-all; overflow-wrap: break-word;">拙ブログより、logging関連エントリ 3/4</h3>
<ul class="simple">
<li><p><a class="reference external" href="https://nikkie-ftnext.hatenablog.com/entry/python-logging-developing-library-take-advantage-nullhandler-and-propagate" rel="noopener noreferrer" target="_blank">Pythonで標準ライブラリloggingを使って自作ライブラリの中でロギングしたい未来の私へ</a></p></li>
<li><p><a class="reference external" href="https://nikkie-ftnext.hatenablog.com/entry/python-logging-docs-improvement-bye-logging-functions-welcome-getlogger" rel="noopener noreferrer" target="_blank">Pythonのloggingモジュールのドキュメント、実は小さく改善しています！👏 ようこそgetLogger()</a></p></li>
</ul>
</section>
<section>
<h3 style="word-break: keep-all; overflow-wrap: break-word;">拙ブログより、logging関連エントリ 4/4</h3>
<ul class="simple">
<li><p><a class="reference external" href="https://nikkie-ftnext.hatenablog.com/entry/python-logging-flow-detailed-logger-level-filter-handler" rel="noopener noreferrer" target="_blank">Pythonでライブラリのロガーを使ったロギングをLogging Flowに沿って、かつフィルタやハンドラの設定にも注意を払って説明する</a></p></li>
</ul>
</section>
</section>
<section>
<h2 style="word-break: keep-all; overflow-wrap: break-word;">お前、誰よ（詳細版）</h2>
<ul class="simple">
<li><p><span class="fab fa-twitter"></span> <a class="reference external" href="https://twitter.com/ftnext" rel="noopener noreferrer" target="_blank">@ftnext</a> ／ 登壇 <a class="reference external" href="https://github.com/ftnext/2024-slides" rel="noopener noreferrer" target="_blank">2024</a> <a class="reference external" href="https://github.com/ftnext/2023-slides" rel="noopener noreferrer" target="_blank">2023</a></p></li>
<li><p>PyCon JP 2021 座長</p></li>
<li><p>毎月の <a class="reference external" href="https://startpython.connpass.com/" rel="noopener noreferrer" target="_blank">みんなのPython勉強会</a> スタッフ</p></li>
<li><p>代表作：Sphinx拡張 <a class="reference external" href="https://github.com/ftnext/sphinx-new-tab-link" rel="noopener noreferrer" target="_blank">sphinx-new-tab-link</a></p></li>
</ul>
</section>
<section>
<h2 style="word-break: keep-all; overflow-wrap: break-word;">EOF</h2>
</section>

        </div>
    </div>
    
    <script src="../_static/revealjs4/dist/reveal.js"></script>
    
    
      <script src="../_static/revealjs4/plugin/highlight/highlight.js"></script>
      <script src="../_static/revealjs4/plugin/notes/notes.js"></script>
      <script src="../_static/revealjs4/plugin/copycode/copycode.js"></script>
      
    
    <script>
        var revealjsConfig = new Object();
        Object.assign(revealjsConfig, {"controls": true, "progress": true, "history": true, "center": true, "transition": "none", "slideNumber": "c/t", "scrollActivationWidth": null});
        
        
        
          revealjsConfig.plugins = [
            RevealHighlight,RevealNotes,CopyCode,
          ];
        
        // More info https://github.com/hakimel/reveal.js#configuration
        Reveal.initialize(revealjsConfig);
    </script>

  </body>
</html>