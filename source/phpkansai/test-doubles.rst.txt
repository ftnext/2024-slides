発展的話題：「モック」
============================================================

いまは分からなかったとしても大丈夫

繰り返し挑んで、少しずつ理解していけばいいんです

別の処理を呼び出す実装のテストコード
--------------------------------------------------

* 全ての処理を通したテストも書ける
* 別の処理が **HTTP通信** のような場合どうするか？
* -> *モック* （後述する *広義*）

モック（mock）
--------------------------------------------------

* **偽物**、模造品（ウィズダム英和辞典）
* 画面の"モック"アップ
* テストコードの文脈では、 *広義* と *狭義* がある（『xUnit Test Patterns』）

広義のモック
--------------------------------------------------

* **Test Doubles** を指して「モック」
* テスト用の **代役**
* テスト対象の関数やメソッドの実装の中で依存するものの代役

参考：『xUnit Test Patterns』における整理
--------------------------------------------------

具体的な代役にはいろいろある

.. figure:: ../_static/phpkansai/xutp-test-doubles.gif

元 http://xunitpatterns.com/Types%20Of%20Test%20Doubles.gif

スタブ（Stub）
--------------------------------------------------

* テスト対象から呼び出す処理が **実際に動かないように** スタブにする
* 例：HTTP通信処理をスタブにする

  * サービスが落ちていなくても異常系のレスポンスが返った（テスト対象に入力された）ことにできる

Mock Object
--------------------------------------------------

* 狭義のモック
* スタブのように、テスト対象から呼び出す処理を実際に動かないようにできる
* 加えて、テスト対象が **モックを期待通り使っているかをassert** できる

例：HTTP通信を呼び出すコードにテストを書きたい
--------------------------------------------------

.. literalinclude:: ../../samplecode/phpunit-example/src/mockExample.php
  :language: php
  :lines: 13-20

例：HTTP通信
--------------------------------------------------

.. literalinclude:: ../../samplecode/phpunit-example/src/mockExample.php
  :language: php
  :lines: 3-11

モックにするためにクラスで実装

Test Doublesを使って書いたテストコード
--------------------------------------------------

.. literalinclude:: ../../samplecode/phpunit-example/tests/mockExampleTest.php
  :language: php
  :lines: 8-17

こんなときにTest Doublesを使っています
--------------------------------------------------

* 外部と通信する関数（通信エラーでテストが落ちうる）
* 時間のかかる関数（テストの実行時間が伸びる）
* 出力が変わる関数（例：random）

🥟モック（Test Doubles）
============================================================

* テストにおける **代役** （具体はStubやMock Object）
* 例えば、外部と通信する処理はモックする
