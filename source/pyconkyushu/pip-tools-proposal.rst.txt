pip-toolsã®ææ¡ˆ
======================================================================

1. pip-toolsã®ç´¹ä»‹
2. pip-toolsã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã«é–¢ã—ã¦ ``pipx``

ä»®æƒ³ç’°å¢ƒ â¤ï¸ pip-tools

transitiveãªä¾å­˜ã®ç®¡ç†ã®ãƒ„ãƒ©ã•ã‚’ã©ã†è§£æ±ºã™ã‚‹ã‹
--------------------------------------------------

* Poetryã‚„Pipenvãªã©ã® **å¼·åŠ›** ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ç®¡ç†æ©Ÿèƒ½ã‚’æŒã£ãŸãƒ„ãƒ¼ãƒ«ğŸ‘
* ã²ã­ãã‚ŒãŸnikkieã€Œãã“ã¾ã§æŒã¡å‡ºã•ãªãã¦ã‚‚ã§ããªã„ã‹ãªã€ï¼ˆã“ã‚Œã‚‰ã®ãƒ„ãƒ¼ãƒ«ã®æ©Ÿèƒ½å…¨éƒ¨ã‚’ä½¿ã†ã‚ã‘ã˜ã‚ƒãªã„ã—ï¼‰

ãã“ã§ã€**pip-tools**
--------------------------------------------------

* RyeãŒä½¿ã£ã¦ã„ã¦çŸ¥ã£ãŸï¼ˆå¾Œè¿°ï¼‰
* **transitiveãªä¾å­˜ã®ç®¡ç†** ã‚’ã†ã¾ãè§£æ±ºã—ã¦ã„ã‚‹ã‚ˆã†ã«æ„Ÿã˜ã‚‹ï¼ˆæœ¬ç™ºè¡¨ã§ææ¡ˆï¼‰

å‚è€ƒï¼šã‚µãƒ¼ãƒ™ã‚¤ã‚ã‚Šã¾ã™ï¼ˆ4æœˆã®stapyï¼‰
--------------------------------------------------

.. raw:: html

    <iframe width="800" height="480" src="https://ftnext.github.io/2024-slides/stapy-april/python-virtual-environment-basic.html#/13"
        title="Pythoné–‹ç™ºç’°å¢ƒ åŸºç¤ @ã¿ã‚“ãªã®Pythonå‹‰å¼·ä¼š#103 (2024/04)"></iframe>

`ç™»å£‡å ±å‘Š | ã¿ã‚“ãªã®Pythonå‹‰å¼·ä¼š#103 ã«ã¦Pythonã§ä»®æƒ³ç’°å¢ƒã«ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ã‚“ã ã¨ï¼ˆãŸã ãã‚Œã ã‘ã‚’ï¼‰è©±ã—ã¾ã—ãŸ <https://nikkie-ftnext.hatenablog.com/entry/stapy-103-python-virtual-environment-basic-talk>`__

pip-tools
======================================================================

https://pypi.org/project/pip-tools/

    pip-tools = pip-compile + pip-sync

**2ã¤ã®ã‚³ãƒãƒ³ãƒ‰** ã‚’æä¾›
--------------------------------------------------

.. image:: ../_static/pyconkyushu/pip-tools-overview.svg

å¼•ç”¨å…ƒ https://github.com/jazzband/pip-tools/blob/7.4.1/img/pip-tools-overview.svg

1ï¸âƒ£ :command:`pip-compile`
--------------------------------------------------

* é–‹ç™ºè€…ã¯ **directãªä¾å­˜ã ã‘** ã‚’æŒ‡å®šã™ã‚‹

  * :file:`requirements.in`
  * :file:`pyproject.toml`

* ``pip-compile`` ãŒï¼ˆ``pip freeze`` åŒæ§˜ã®ï¼‰ :file:`requirements.txt` ã‚’ä½œã£ã¦ãã‚Œã‚‹

:command:`pip-compile` ã®ä¾‹
--------------------------------------------------

.. code-block:: shell

    % cat requirements.in
    transformers
    rouge-score
    % pip-compile

ç”Ÿæˆã•ã‚ŒãŸ :file:`requirements.txt` ï¼ˆä¸€éƒ¨ï¼‰
--------------------------------------------------

.. code-block:: txt

    nltk==3.8.1
        # via rouge-score
    rouge-score==0.1.2
        # via -r requirements.in
    six==1.16.0
        # via rouge-score
    tqdm==4.66.4
        # via
        #   nltk
        #   transformers

2ï¸âƒ£ :command:`pip-sync`
--------------------------------------------------

* ä»®æƒ³ç’°å¢ƒã‚’ :file:`requirements.txt` ã¨ **åŒæœŸ**

.. code-block:: shell

    % pip-sync --python-executable .venv/bin/python

ğŸ¥Ÿpip-toolsã‚’ä½¿ã£ãŸä¾å­˜ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ç®¡ç†
--------------------------------------------------

1. é–‹ç™ºè€…ãŒdirectãªä¾å­˜ã‚’æŒ‡å®šï¼ˆ:file:`requirements.in` ã‚„ :file:`pyproject.toml` ãªã©ï¼‰
2. :command:`pip-compile` ã§ :file:`requirements.txt` ã‚’è‡ªå‹•ç”Ÿæˆ
3. :command:`pip-sync` ã§ä»®æƒ³ç’°å¢ƒã‚’ :file:`requirements.txt` ã¨åŒæœŸ

pip-toolsã®è³¢ã„ã¨ã“ã‚
--------------------------------------------------

* ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã® ``python -m pip freeze`` ã¯ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ãŸçµæœã‚’ãƒ€ãƒ³ãƒ—ã™ã‚‹
* pip-toolsã¯ã€ä»®æƒ³ç’°å¢ƒã«å…¥ã‚Œã‚‹ **å‰** ã«ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®çµ„åˆã›ã‚’ç®—å‡ºï¼ˆ``pip-compile``ï¼‰

:command:`pip-compile-multi` ğŸƒâ€â™‚ï¸
------------------------------------------------------------

* ``pip install awesomelib[extra]``
* **extraã”ã¨** ã« ``pip-compile`` ã§ãã‚‹
* è©³ã—ãã¯ `pip-compile-multiä½“é¨“è¨˜ï¼šå°ã•ãåˆ†ã‘ãŸrequirementsãƒ•ã‚¡ã‚¤ãƒ«ãŸã¡ã‚’å…ƒã«ã€ç’°å¢ƒã‚’lockã—ã¦ç®¡ç†ã§ãã‚‹ï¼ <https://nikkie-ftnext.hatenablog.com/entry/pip-compile-multi-first-step>`__

transitiveãªä¾å­˜ã®ç®¡ç†ã®èª²é¡Œã«å¯¾ã—ã¦
======================================================================

.. code-block:: shell

    % cat requirements.in
    transformers
    rouge-score
    % pip-compile
    % pip-sync --python-executable .venv/bin/python

rouge-scoreã¯ä½¿ã‚ãªã„ã“ã¨ã«
--------------------------------------------------

.. code-block:: shell

    % cat requirements.in  # é–‹ç™ºè€…ãŒç·¨é›†ã—ãŸå¾Œ
    transformers
    % pip-compile
    % pip-sync --python-executable .venv/bin/python

rouge-scoreã ã‘ãŒä¾å­˜ã™ã‚‹ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚‚æ¶ˆãˆãŸï¼
--------------------------------------------------

.. code-block:: shell

    % pip-sync --python-executable .venv/bin/python

    Found existing installation: rouge_score 0.1.2
    Uninstalling rouge_score-0.1.2:
      Successfully uninstalled rouge_score-0.1.2
    Found existing installation: six 1.16.0
    Uninstalling six-1.16.0:
      Successfully uninstalled six-1.16.0

å‡ºåŠ›ã®ä¸€éƒ¨æŠœç²‹

pip-toolsåˆ©ç”¨ã‚·ãƒ¼ãƒ³ã‚ˆã‚Š
======================================================================

* ã“ã®ã‚¹ãƒ©ã‚¤ãƒ‰ã®ãƒªãƒã‚¸ãƒˆãƒª `2024-slides <https://github.com/ftnext/2024-slides>`__ ğŸ‘ˆ
* Djangoã®ç·´ç¿’ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ `djoser-practice <https://github.com/ftnext/djoser-practice>`__

dependabotãŒæ•™ãˆã¦ãã‚Œã‚‹
--------------------------------------------------

* ç›´è¿‘ã§ã€Œrequestsã‚’ **2.32.0ä»¥ä¸Š** ã«ã—ã‚ˆã†ã€
* `Session object does not verify requests after making first request with verify=False (Severity Moderate) <https://github.com/psf/requests/security/advisories/GHSA-9wx4-h78v-vm56>`__
* requestsã¯ã€transitiveãªä¾å­˜ã«ã‚ãŸã‚‹ï¼ˆdirectãªä¾å­˜ã‚‚åŒæ§˜æ‰‹é †ï¼‰

.. directãªä¾‹ https://github.com/ftnext/2024-slides/commit/6350bf8a93c9fabd36c03650cea8895dfe6b4b0e

ç‰¹å®šã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã® **ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ä¸Šã’ã‚‹** ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼
------------------------------------------------------------

.. code-block:: shell

    % pip-compile --upgrade-package requests
    % pip-sync --python-executable .venv/bin/python

https://github.com/ftnext/2024-slides/commit/62eb18134e95704acc9fb21cbd0e86f437153f88

ğŸŒ¯pip-toolsã®ææ¡ˆ
======================================================================

* transitiveãªä¾å­˜ã®ç®¡ç†ã®èª²é¡Œã«ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ
* **é–‹ç™ºè€…ã¯directãªä¾å­˜ã ã‘ã‚’æŒ‡å®šã™ã‚‹**
* pip-toolsãŒé–‹ç™ºè€…ã«ä»£ã‚ã£ã¦transitiveãªä¾å­˜ã‚’ç®¡ç†ã—ã¦ãã‚Œã‚‹

å‚è€ƒ pip-toolsã«ã¤ã„ã¦ï¼ˆè¨˜äº‹ç‰ˆï¼‰ğŸƒâ€â™‚ï¸
------------------------------------------------------------

* `pip-toolsä½“é¨“è¨˜ï¼špip-compileã§ä½œã£ãŸrequirements.txtã®é€šã‚Šã«ç’°å¢ƒãŒåŒæœŸï¼ˆpip-syncï¼‰ã™ã‚‹ï¼ <https://nikkie-ftnext.hatenablog.com/entry/pip-tools-first-step-compile-then-sync>`__
* `pipxã§ç®¡ç†ã™ã‚‹pip-toolsã‚’ä½¿ã£ã¦ã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ä»®æƒ³ç’°å¢ƒã«ä¾å­˜ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ï¼ˆpip-syncã®--python-executableå¼•æ•°ãŒå¿…è¦ï¼‰ <https://nikkie-ftnext.hatenablog.com/entry/pipx-install-example-pip-tools>`__

pip-toolsã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã«ã¤ã„ã¦ï¼ˆã®æ„è¦‹ï¼‰
======================================================================

* `README <https://github.com/jazzband/pip-tools/tree/7.4.1?tab=readme-ov-file#installation>`__ ã§ã¯ã€ä»®æƒ³ç’°å¢ƒã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ã‚ˆã†æ¡ˆå†…ã•ã‚Œã‚‹
* ã©ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ä»®æƒ³ç’°å¢ƒã«ã‚‚å…¥ã‚Œã‚‹ï¼ŸğŸ¤”

**pipx** ã§1å›ã ã‘å…¥ã‚Œã‚‹ã®ã‚’æ¨ã—ã¦å‚ã‚‹
--------------------------------------------------

.. code-block:: shell

    % pipx install pip-tools --python python3.11

* pipx 1.5.0
* Python 3.11.7
* pip-tools 7.4.1

pipxã£ã¦ã€ä½•ã‚ˆï¼Ÿ
--------------------------------------------------

* https://github.com/pypa/pipx
* PyPIã‚’App StoreåŒ–è¨ˆç”»
* ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³ã ã‘ã§å‹•ã‹ã™ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã€**pipxãŒç®¡ç†ã™ã‚‹å€‹åˆ¥ã®ä»®æƒ³ç’°å¢ƒ** ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ãã‚Œã‚‹

ã„ã¤ã‚‚ä»®æƒ³ç’°å¢ƒã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã¯ :command:`pipx install` ã§ã„ã„ã®ã§ã¯
----------------------------------------------------------------------------------------------------

`Installing stand alone command line tools <https://packaging.python.org/en/latest/guides/installing-stand-alone-command-line-tools/>`__

* pipxãŒ **pip-toolsã ã‘ã®ã‚°ãƒ­ãƒ¼ãƒãƒ«ãªä»®æƒ³ç’°å¢ƒ** ã‚’ç®¡ç†ã—ã¦ãã‚Œã‚‹
* mypyã‚„ `Ruff <https://gihyo.jp/article/2023/03/monthly-python-2303>`__ ãªã©ã‚‚ç§ã¯ ``pipx install`` ã—ãŸã„

pipxè‡ªä½“ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
--------------------------------------------------

* macOSã¯ :command:`brew install pipx` ğŸ™‹â€â™‚ï¸
* Ubuntu 23.04ä»¥é™ã§ :command:`apt install pipx`
* :command:`python3 -m pip install --user pipx`

ğŸ“Œ :command:`pipx ensurepath` ã‚’ãŠå¿˜ã‚Œãªã

https://github.com/pypa/pipx/tree/1.5.0?tab=readme-ov-file#install-pipx
